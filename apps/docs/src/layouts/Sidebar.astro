---
import { getCollection } from "astro:content";
import ArrowIcon from "../components/ArrowIcon.astro";
import WathqnyConfig from "../wathqny.config";
import { Debug } from "astro:components";

const docs = await getCollection("docs");

const { sidebar } = WathqnyConfig;

docs.sort((a, b) => (a.data.position > b.data.position ? 1 : -1));
---

<aside class="wtq-sidebar">
  <div>
    <ul class="wtq-sidebar-category" role="tablist">
      {
        sidebar?.map((category) => {
          let activeClass = "";
          let cutUrl =
            "/" +
            Astro.url.pathname
              .split("/")
              .filter((url) => {
                if (url != "") {
                  return true;
                }
              })
              .reverse()[0];

          docs.map((doc) => {
            if (doc.data.href == cutUrl && doc.data.category == category) {
              activeClass = "wtq-active";
            }
          });
          return (
            // <Debug {cutUrl} />
            <li class={activeClass} role="tab">
              <span
                role="button"
                aria-expanded="false"
                tabindex="0"
                class={`wtq-sidebar-category-link ${activeClass}`}
                id={`${category}-category`}
                aria-label={`Go to ${category} category`}>
                {category} <ArrowIcon />
              </span>
              <ul class="wtq-sidebar-category-collapse">
                {docs.map((doc) => {
                  return (
                    doc.data.category == category && (
                      <li class="wtq-doc-list-item">
                        <a
                          tabindex="-1"
                          class="wtq-doc-link"
                          href={"/docs/" + category + doc.data.href}>
                          {doc.data.title}
                        </a>
                      </li>
                    )
                  );
                })}
              </ul>
            </li>
          );
        })
      }
    </ul>
  </div>
</aside>

<script lang="ts">
  const categoryItems = document.querySelectorAll(".wtq-sidebar-category li");

  categoryItems.forEach((categoryItem) => {
    const categoryItemLinks = categoryItem.querySelectorAll(".wtq-doc-link");
    const collapse = categoryItem.querySelector(
      ".wtq-sidebar-category-collapse"
    );
    const icon = categoryItem.querySelector(".wtq-sidebar-category-link");

    categoryItem?.addEventListener("keydown", (e) => {
      if (e.key == "Enter") {
        if (categoryItem.classList.contains("wtq-active")) {
          categoryItemLinks.forEach((categoryItemLink) => {
            categoryItemLink.setAttribute("tabindex", -1);
          });
          icon?.classList.remove("wtq-active");
          categoryItem?.classList.remove("wtq-active");
          collapse.style.maxHeight = null;
        } else {
          categoryItemLinks.forEach((categoryItemLink) => {
            categoryItemLink.removeAttribute("tabindex");
          });
          collapse.style.maxHeight = collapse.scrollHeight + "px";
          icon?.classList.add("wtq-active");
          categoryItem?.classList.add("wtq-active");
        }
      }
    });

    categoryItem?.addEventListener("click", () => {
      if (categoryItem.classList.contains("wtq-active")) {
        categoryItemLinks.forEach((categoryItemLink) => {
          categoryItemLink.removeAttribute("tabindex");
        });
        icon?.classList.remove("wtq-active");
        categoryItem?.classList.remove("wtq-active");
        collapse.style.maxHeight = null;
      } else {
        categoryItemLinks.forEach((categoryItemLink) => {
          categoryItemLink.setAttribute("tabindex", -1);
        });
        collapse.style.maxHeight = collapse.scrollHeight + "px";
        icon?.classList.add("wtq-active");
        categoryItem?.classList.add("wtq-active");
      }
    });

    if (categoryItem.classList.contains("wtq-active")) {
      collapse.style.maxHeight = collapse.scrollHeight + "px";
    }
  });
</script>
